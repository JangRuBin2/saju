# 사주 서비스 개발 유의사항

## 1. 아키텍처 설계 원칙

### 핵심: 계산과 해석을 반드시 분리할 것

```
사용자 입력 (생년월일시, 성별)
    ↓
[만세력 엔진] ← 규칙 기반 알고리즘 (직접 구현)
    ↓
정확한 사주 데이터 (JSON)
    ↓
[LLM API] ← 프롬프트에 사주 데이터 + 해석 가이드라인 주입
    ↓
자연어 해석 결과
```

- **만세력 계산**: 절대 LLM에 위임하지 않는다. LLM은 천간지지 변환, 절기 판단 등에서 높은 확률로 오류를 발생시킨다.
- **해석 생성**: LLM API(Claude, ChatGPT 등)를 활용하되, 반드시 계산된 데이터를 프롬프트에 주입하는 방식으로 사용한다.

---

## 2. 만세력 엔진 구현 시 유의사항

### 2-1. 절기(節氣) 기준 월주 계산

- 사주의 월주는 양력/음력 월이 아니라 **24절기 중 '절(節)' 기준**으로 바뀐다.
- 예: 입춘(2/4경) 이전 출생 → 전년도 연주 적용
- 절기 전환 시각은 매년 미세하게 다르므로, **연도별 정확한 절기 시각 데이터**가 필요하다.
- 절기 시각은 한국천문연구원 또는 Hong Kong Observatory 데이터를 참고할 수 있다.

### 2-2. 시주(時柱) 계산

- 시주는 태어난 시각을 **12지지 시간대**로 변환한다.
- 자시(子時, 23:00~01:00)는 **야자시(夜子時)** 문제가 있다.
  - 23:00~00:00을 당일로 볼지, 다음날로 볼지 학파마다 다르다.
  - 서비스 정책을 정하고, 사용자에게 어떤 기준인지 명시해야 한다.
- **서머타임(일광절약시간)**: 한국은 1948~1961년 사이 서머타임을 시행했으므로, 해당 기간 출생자는 1시간 보정이 필요하다.

### 2-3. 음양력 변환

- 사용자 입력이 음력인 경우 양력 변환 필요 (윤달 처리 주의)
- npm: `korean-lunar-calendar`, `lunar-javascript`
- 윤달(閏月) 출생자 처리 정책을 명확히 정해야 한다.

### 2-4. 대운(大運) 계산

- 성별 + 연주 천간의 음양에 따라 대운의 **순행/역행**이 결정된다.
  - 남자 양간 or 여자 음간 → 순행
  - 남자 음간 or 여자 양간 → 역행
- 대운 시작 나이 계산: 출생일로부터 다음(또는 이전) 절기까지의 일수를 3으로 나누어 산출한다.
- 대운 전환 시점의 정확한 계산이 서비스 신뢰도에 직결된다.

### 2-5. 추천 라이브러리/리소스

| 구분        | 라이브러리                    | 비고                     |
| ----------- | ----------------------------- | ------------------------ |
| 음양력 변환 | `korean-lunar-calendar` (npm) | 한국 음력 특화           |
| 간지 계산   | `lunar-javascript` (npm)      | 절기, 간지, 신살 등 포괄 |
| 절기 데이터 | 한국천문연구원 API            | 정밀 절기 시각           |
| Python      | `cnlunar`, `lunarcalendar`    | Python 기반 프로젝트 시  |

> ⚠️ 라이브러리를 사용하더라도 반드시 만세력 책 또는 신뢰할 수 있는 만세력 사이트와 교차 검증할 것

---

## 3. LLM API 활용 시 유의사항

### 3-1. 프롬프트 설계

```
[시스템 프롬프트]
- 역할 정의: "당신은 30년 경력의 사주명리학 전문가입니다"
- 해석 원칙: 일간 중심 해석, 오행 균형 분석, 용신/희신 판단
- 톤 가이드: 부정적 내용은 조언 형태로 전환
- 출력 구조: 섹션별 해석 (성격, 재물, 직업, 연애, 건강, 올해 운세 등)
- 금지 사항: 구체적 날짜/숫자 예측, 의료/법률 조언, 극단적 부정 표현

[사용자 프롬프트]
- 계산된 사주 데이터를 JSON으로 전달
- 요청하는 해석 유형 (종합운세, 궁합, 올해 운세 등)
```

### 3-2. 해석 품질 관리

- **일관성 문제**: 같은 사주를 여러 번 요청하면 매번 다른 해석이 나올 수 있다.
  - `temperature`를 0.3~0.5 수준으로 낮춰 일관성 확보
  - 또는 주요 해석 결과를 캐싱하여 동일 사주에 동일 결과 제공
- **환각(Hallucination)**: LLM이 존재하지 않는 사주 이론을 만들어낼 수 있다.
  - 시스템 프롬프트에 사주 해석 원칙/용어 정의를 상세히 기술
  - 해석 결과에 대한 사후 검증 로직 고려 (키워드 체크 등)
- **깊이 조절**: 무료/유료 티어에 따라 해석 깊이를 다르게 설정
  - 무료: 간략 해석 (max_tokens 제한)
  - 유료: 상세 해석 + 후속 질문 가능

### 3-3. Claude API vs ChatGPT API 비교

| 항목                 | Claude (Anthropic)       | GPT-4o (OpenAI)         |
| -------------------- | ------------------------ | ----------------------- |
| 컨텍스트 윈도우      | 200K 토큰                | 128K 토큰               |
| 시스템 프롬프트 준수 | 강함 (해석 톤/구조 일관) | 양호 (가끔 벗어남)      |
| 한국어 사주 용어     | 잘 이해함                | 잘 이해함               |
| 환각 경향            | 상대적으로 적음          | 자신감 있게 틀리는 경향 |
| 저비용 모델          | Haiku (가장 저렴)        | GPT-4o-mini             |
| 스트리밍             | 지원                     | 지원                    |

> 💡 사주 해석처럼 가이드라인 준수가 중요한 경우, Claude API가 상대적으로 유리하다.
> 💡 비용 최적화 시, 간략 해석은 경량 모델(Haiku/4o-mini), 상세 해석은 상위 모델(Sonnet/4o)로 분기할 수 있다.

### 3-4. 비용 관리

- 사주 해석 1회당 대략 1,000~3,000 토큰 소모 (시스템 프롬프트 포함 시 더 많음)
- 시스템 프롬프트는 매 요청마다 전송되므로, 프롬프트 캐싱(Prompt Caching) 기능 활용 권장
- 자주 요청되는 사주 조합은 해석 결과를 DB에 캐싱하여 API 호출 절감

---

## 4. 데이터 & 법률 유의사항

### 4-1. 개인정보 처리

- 생년월일시 + 성별은 **개인정보**에 해당한다.
- 개인정보처리방침 수립 및 고지 필수
- 회원가입 없이 사용 가능한 구조라면 서버에 데이터를 저장하지 않는 방식 고려
- 데이터 보관 시 암호화 처리 필수

### 4-2. 서비스 면책 고지

- "본 서비스는 오락 및 참고 목적이며, 전문적인 상담을 대체하지 않습니다"
- 의료, 법률, 투자 관련 판단의 근거로 사용하지 않도록 안내
- 이 면책 조항은 서비스 내에서 눈에 잘 띄는 곳에 배치해야 한다

### 4-3. 사업자 등록 관련

- 통신판매업 신고 (유료 서비스 시)
- 부가통신사업 신고 (앱 서비스 시)
- 상표 등록: 서비스명 확정 후 특허청 KIPRIS에서 선등록 여부 확인

---

## 5. UX/UI 유의사항

### 5-1. 입력 폼 설계

- **태어난 시간을 모르는 경우** 처리가 매우 중요 (사용자의 30~40%가 모름)
  - "시간 모름" 옵션 제공 → 시주 제외한 삼주(三柱) 해석
  - 시간 미입력 시에도 의미 있는 결과를 제공해야 서비스 이탈 방지
- 음력/양력 선택 UI를 직관적으로 제공
- 윤달 여부 체크박스 (음력 선택 시)

### 5-2. 결과 표시

- 사주 차트(팔자표)를 시각적으로 보여주는 것이 신뢰감을 높임
- 오행 비율을 차트(도넛/바)로 시각화
- 해석 텍스트는 섹션별로 구분 (한 번에 긴 텍스트 X)
- 스트리밍 응답을 활용하면 사용자 대기 경험 개선

### 5-3. 공유 기능

- 결과를 이미지(카드형)로 저장/공유 → 바이럴 핵심
- 궁합 결과 공유 시 상대방 정보는 최소화하여 프라이버시 보호

---

## 6. 성능 & 확장성

### 6-1. API 호출 최적화

```typescript
// 프롬프트 캐싱 예시 (Anthropic)
const response = await client.messages.create({
  model: "claude-sonnet-4-5-20250514",
  system: [
    {
      type: "text",
      text: SAJU_SYSTEM_PROMPT, // 긴 시스템 프롬프트
      cache_control: { type: "ephemeral" }, // 캐싱 활성화
    },
  ],
  messages: [{ role: "user", content: userPrompt }],
  max_tokens: 2000,
  temperature: 0.4,
});
```

### 6-2. 응답 시간 관리

- LLM 해석 생성에 3~10초 소요될 수 있음
- 스트리밍 응답으로 체감 대기시간 줄이기
- 만세력 계산은 즉시 보여주고, 해석은 이후 로딩되는 2단계 UI 고려

### 6-3. 캐싱 전략

- 동일 사주(같은 생년월일시 + 성별)의 기본 해석은 캐싱 가능
- 세운/월운 등 시간에 따라 변하는 해석은 별도 관리
- Redis 또는 DB 캐싱으로 API 비용 절감

---

## 7. 체크리스트

- [x] 만세력 엔진 구현 (lunar-python 래핑, 테스트 32개 통과)
- [ ] 만세력 교차 검증 (최소 100개 사례)
- [x] 야자시 처리 정책 결정 (use_night_zi 파라미터로 사용자 선택)
- [x] 서머타임 보정 로직 구현 (1948~1961년생)
- [x] 음력 → 양력 변환 및 윤달 처리
- [x] LLM 시스템 프롬프트 설계 (종합해석, 궁합, 운세)
- [x] temperature, max_tokens 등 파라미터 튜닝 (0.4 / 3000)
- [x] 태어난 시간 미입력 시 삼주 해석 대응
- [x] 캐싱 전략 수립 및 구현 (Redis, graceful degradation)
- [ ] 개인정보처리방침 작성
- [ ] 면책 조항 배치
- [ ] 사업자 등록 및 통신판매업 신고
- [ ] 결과 공유용 이미지 생성 기능
- [ ] API 비용 모니터링 대시보드
- [ ] 부하 테스트 (동시 사용자 시나리오)
